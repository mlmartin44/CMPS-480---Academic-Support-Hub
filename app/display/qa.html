<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Academic Support Hub — Q&A</title>
  <link rel="stylesheet" href="qastyle.css?v=3" />
</head>
<body>
  <header class="topbar">
    <h1>Academic Support Hub</h1>
    <nav class="mainnav">
      <a href="home.html">Home Page</a>
      <a href="study-groups.html">Study Groups</a>
      <a href="resources.html">Resources</a>
      <a href="qa.html">Q&amp;A</a>
      <a href="planner.html">Planner</a>
    </nav>
  </header>

  <main class="container">
    <h2 style="margin:16px 0 12px;">Q&amp;A</h2>

    
    <div class="card">
      <h3>Ask a Question</h3>
      <div class="grid cols-2">
        <label>Course
          <select id="qa-courseId"></select>
        </label>
        <label>Author
          <input id="qa-author" type="text" value="Ethan" />
        </label>
      </div>
      <label style="display:block;margin-top:8px;">Question
        <textarea id="qa-content" rows="4" placeholder="Type your question..."></textarea>
      </label>
      <div style="margin-top:12px;display:flex;gap:8px;align-items:center;">
        <button id="qa-post">Post</button>
        <button id="qa-refresh" class="ghost">Refresh</button>
        <span id="qa-status" class="muted"></span>
      </div>
    </div>

  
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <h3>Questions</h3>
        <label class="muted">Filter by course:
          <select id="qa-filterId">
            <option value="">All</option>
          </select>
        </label>
      </div>
      <div id="qa-list"></div>
      <p id="qa-empty" class="muted" style="display:none;">No questions yet.</p>
    </div>
  </main>

  
  <script src="reactions.js?v=3"></script>
  <script>
   
    console.log("Reactions present?", typeof Reactions !== "undefined");
  </script>

  <script>
    const listEl     = document.getElementById('qa-list');
    const emptyEl    = document.getElementById('qa-empty');
    const statusEl   = document.getElementById('qa-status');
    const filterIdEl = document.getElementById('qa-filterId');
    const courseIdEl = document.getElementById('qa-courseId');

    const esc = (s='') => s.toString().replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));

    async function fetchJSON(url, opts) {
      const res = await fetch(url, opts);
      if (!res.ok) {
        let msg = `${res.status}`;
        try { const j = await res.json(); if (j.message) msg = j.message; } catch {}
        throw new Error(msg);
      }
      return res.json();
    }

    async function loadCourses() {
      const rows = await fetchJSON('/api/courses');
      const options = ['<option value="">All</option>']
        .concat(rows.map(c => `<option value="${c.CourseID}">${esc(c.CourseName)} (${c.CourseID})</option>`))
        .join('');
      filterIdEl.innerHTML = options;

      const askOptions = rows.map(c => `<option value="${c.CourseID}">${esc(c.CourseName)} (${c.CourseID})</option>`).join('');
      courseIdEl.innerHTML = askOptions;
    }

    async function fetchQuestions() {
      const courseId = filterIdEl.value.trim();
      const url = courseId ? `/api/questions?courseId=${encodeURIComponent(courseId)}` : '/api/questions';
      return fetchJSON(url);
    }

    function renderList(items) {
      listEl.innerHTML = '';
      if (!items.length) {
        emptyEl.style.display = 'block';
        return;
      }
      emptyEl.style.display = 'none';

      for (const q of items) {
        const row = document.createElement('div');
        row.className = 'item-row';
        row.innerHTML = `
          <div>
            <div><strong>${esc(q.author)}</strong> asked:</div>
            <div class="muted" style="margin:2px 0 6px 0;">CourseID: ${q.courseId ?? ''} • id ${q.id}</div>
            <div>${esc(q.content)}</div>
          </div>
          <div class="reactions-mount"></div>
        `;
        listEl.appendChild(row);

        const mount = row.querySelector('.reactions-mount');
        if (typeof Reactions !== 'undefined' && Reactions.mount) {
          Reactions.mount(mount, {
            id: q.id,
            type: 'question',
            author: q.author,
            text: q.content,
            createdAt: 'just now'
          });
        } else {
          
          mount.innerHTML = '<div class="muted">Reactions not available</div>';
        }
      }
    }

    function status(msg) { statusEl.textContent = msg; }

    async function load() {
      try {
        status('Loading…');
        const data = await fetchQuestions();
        renderList(data);
        status('');
      } catch (e) {
        console.error(e);
        status('Failed to load questions.');
      }
    }

    async function postQuestion() {
      const courseId = courseIdEl.value.trim();
      const author   = document.getElementById('qa-author').value.trim();
      const content  = document.getElementById('qa-content').value.trim();

      if (!author || !content) {
        alert('Author and question are required.');
        return;
      }

      try {
        status('Posting…');
        await fetchJSON('/api/questions', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            courseId: courseId ? Number(courseId) : null,
            author,
            content
          })
        });
        document.getElementById('qa-content').value = '';
        await load();
        status('Posted!');
        setTimeout(() => status(''), 1000);
      } catch (e) {
        console.error(e);
        status('Failed to post.');
      }
    }

    document.getElementById('qa-post').addEventListener('click', postQuestion);
    document.getElementById('qa-refresh').addEventListener('click', load);
    filterIdEl.addEventListener('change', load);

    (async () => {
      await loadCourses();
      await load();
    })();
  </script>
</body>
</html>
